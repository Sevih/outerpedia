import rawGuides from '@/data/guides/guides-ref.json'
import rawCategoryMeta from '@/data/guides/categories.json'
import { notFound } from 'next/navigation'
import GuideContentWrapper from './GuideContentWrapper'
import Link from 'next/link'
import Image from 'next/image'
import type { Metadata } from 'next'
import { getTenantServer } from '@/tenants/tenant.server'
import type { TenantKey } from '@/tenants/config'

export const dynamic = 'force-dynamic'
export const revalidate = 0

type Localized = { en: string; jp?: string; kr?: string }
const getLocalized = (v: Localized | string, lang: TenantKey) =>
  typeof v === 'string' ? v : (v[lang] ?? v.en)

function dedupeByLocale(list: string[], lang: TenantKey): string[] {
  const norm = (s: string) => (lang === 'en' ? s.toLowerCase() : s)
  return Array.from(new Map(list.map(k => [norm(k), k])).values())
}

type Guide = {
  category: string
  title: string | Localized
  description: string | Localized
  icon: string
  last_updated: string
  author: string
  second_image?: string
}

type Props = {
  params: {
    category: string
    slug: string
  }
}

type CategoryMeta = {
  title: string | Localized
  description: string | Localized
  icon: string
  valid: boolean
}

const categoryMeta = rawCategoryMeta as Record<string, CategoryMeta>
const guides = rawGuides as Record<string, Guide>

// üìå G√©n√©ration des routes statiques
export async function generateStaticParams() {
  return Object.entries(guides).map(([slug, guide]) => ({
    category: guide.category,
    slug,
  }))
}

// üìå M√©tadonn√©es dynamiques pour SEO
export async function generateMetadata({ params }: { params: Promise<Props['params']> }): Promise<Metadata> {
  const { key: langKey, domain } = await getTenantServer()
  const { category, slug } = await params
  const guide = guides[slug]

  if (!guide || guide.category !== category) {
    return { title: 'Guide not found', description: 'This guide does not exist.' }
  }

  const meta = categoryMeta[category]
  const metaTitle = getLocalized(meta.title, langKey) // titre de la categorie
  //const metaDesc = getLocalized(meta.description, langKey) // desc de la categorie ex general
  const guideTitle = getLocalized(guide.title, langKey) //titre du guide afficher
  const guideDesc = getLocalized(guide.description, langKey) // desc du guide afficher

  let image: string

  // ‚úÖ Canonical toujours sur le domaine EN
  const canonical = `https://outerpedia.com/guides/${guide.category}/${slug}`

  // ‚úÖ hreflang (alternates.languages)
  const languages: Record<string, string> = {
    en: `https://outerpedia.com/guides/${guide.category}/${slug}`,
    jp: `https://jp.outerpedia.com/guides/${guide.category}/${slug}`,
    kr: `https://kr.outerpedia.com/guides/${guide.category}/${slug}`,
  }

  switch (guide.category) {
    case 'monad-gate':
      image = `https://${domain}/images/guides/monad-gate/CM_Adventure_MonadGate.png`
      break
    default:
      image = `https://${domain}/images/guides/${guide.category}/${slug}_portrait.png`
      break
  }

  const metadata = {
    title: `${guideTitle} | ${metaTitle} | Outerpedia`,
    description: `${metaTitle} ${guideTitle} ${guideDesc}`,
    keywords: generateGuideKeywords(
      { ...guide, title: guideTitle, description: guideDesc },
      slug,
      langKey                    // ‚¨ÖÔ∏è ajoute la locale
    ),
    alternates: {
      canonical,
      languages,
    },
    openGraph: {
      title: `${guideTitle} | ${metaTitle} | Outerpedia`,
      description: `${metaTitle} ${guideTitle} ${guideDesc}`,
      type: 'article',
      url: canonical,
      images: [{ url: image, width: 150, height: 150, alt: `${guideTitle} portrait` }],
    },
    twitter: {
      card: 'summary',
      title: `${guideTitle} | ${metaTitle} | Outerpedia`,
      description: `${metaTitle} ${guideTitle} ${guideDesc}`,
      images: [image],
    },
  }

  //console.log('Generated metadata for /guides/[category]/[slug]:', metadata)
  return metadata
}

// üìå Rendu principal de la page
export default async function GuidePage({ params }: { params: Promise<Props['params']> }) {
  const { key: langKey, domain } = await getTenantServer()
  const { category, slug } = await params
  const guide = guides[slug]

  if (!guide || guide.category !== category) {
    notFound()
  }

  const meta = categoryMeta[category]
  const metaTitle = getLocalized(meta.title, langKey)
  const guideTitle = getLocalized(guide.title, langKey)
  const guideDesc = getLocalized(guide.description, langKey)
  const pageUrl = `https://${domain}/guides/${category}/${slug}`
  let image: string
  let secondeimage: string | undefined

  switch (guide.category) {
    case 'monad-gate':
      image = `/images/guides/monad-gate/CM_Adventure_MonadGate.webp`
      secondeimage = `/images/guides/monad-gate/CM_Adventure_MonadGate.webp`
      break
    default:
      image = `/images/guides/${guide.category}/${slug}_banner.webp`
      secondeimage = guide.second_image
        ? `/images/guides/${guide.category}/${guide.second_image}_banner.webp`
        : undefined
      break
  }

  return (
    <div className="p-6">
      <div className="sr-only">
        <h1>{`${guideTitle} | ${metaTitle}`}</h1>
      </div>
      <div className="relative w-full h-[150px] rounded-2xl overflow-hidden mb-6">
        {/* Image centr√©e */}
        {!secondeimage ? (
          <Image
            src={image}
            alt={`${guideTitle} banner`}
            fill
            sizes="100vw"
            className="object-contain z-0"
            priority
          />
        ) : (
          <>
            <Image
              src={image}
              alt={`${guideTitle} banner`}
              fill
              sizes="100vw"
              className="object-contain"
              style={{ left: '20%' }}
              priority
            />
            <Image
              src={secondeimage}
              alt={`${guideTitle} second banner`}
              fill
              sizes="100vw"
              className="object-contain"
              style={{ left: '-20%' }}
            />
          </>
        )}

        {/* Fl√®che retour */}
        <div className="absolute top-4 left-4 z-20 h-[32px] w-[32px]">
          <Link href={`/guides/${category}`} className="relative block h-full w-full">
            <Image
              src="/images/ui/CM_TopMenu_Back.webp"
              alt="Back"
              fill
              sizes="32px"
              className="opacity-80 hover:opacity-100 transition-opacity"
            />
          </Link>
        </div>

        {/* Texte positionn√© sur la zone rouge */}
        <div className="absolute inset-0 flex flex-col items-center justify-center z-10 text-white text-center px-4">
          <div className="text-xs sm:text-sm uppercase tracking-wide font-semibold mb-3">
            <span className="guide-title">{category.replace(/-/g, ' ')}</span>
          </div>
          <div className="text-base sm:text-lg md:text-xl font-bold leading-tight max-w-full break-words">
            <span className="guide-title mt-4">{guideTitle}</span>
          </div>
        </div>
      </div>

      <div className="text-sm text-neutral-400 mb-6">
        ‚úçÔ∏è {guide.author} ¬∑ üïí {new Date(guide.last_updated).toLocaleDateString()}
      </div>

      {category === 'general-guides' ? (
        <p className="text-sm text-gray-300 max-w-3xl mt-2 m-auto text-center mb-4">
          This guide provides information and advice about <strong>{guideTitle}</strong> in Outerplane.<br />
          If you have additional tips or notice any missing details, feel free to share them with us on&nbsp;
          <Link
            href="https://discord.gg/keGhVQWsHv"
            target="_blank"
            rel="noopener noreferrer"
            className="hover:underline inline-flex items-center gap-1 text-amber-300"
          >
            EvaMains Discord
          </Link>.
        </p>
      ) : category === 'special-request' ? (
        <p className="text-sm text-gray-300 max-w-3xl mt-2 m-auto text-center mb-4">
          This guide provides strategies and tips for defeating the <strong>{guideTitle}</strong> gear boss in Outerplane.<br />
          If you know any additional tactics, team compositions, or optimizations, feel free to share them with us on&nbsp;
          <Link
            href="https://discord.gg/keGhVQWsHv"
            target="_blank"
            rel="noopener noreferrer"
            className="hover:underline inline-flex items-center gap-1 text-amber-300"
          >
            EvaMains Discord
          </Link>.
        </p>
      ) : (
        <p className="text-sm text-gray-300 max-w-3xl mt-2 m-auto text-center mb-4">
          This guide covers all currently available information and advice for <strong>{category.replace(/-/g, ' ')}</strong> ‚Äì <strong>{guideTitle}</strong> in Outerplane.<br />
          If you know any additional strategies, tips, or missing details, feel free to share them with us on&nbsp;
          <Link
            href="https://discord.gg/keGhVQWsHv"
            target="_blank"
            rel="noopener noreferrer"
            className="hover:underline inline-flex items-center gap-1 text-amber-300"
          >
            EvaMains Discord
          </Link>.
        </p>
      )}

      <div className="mt-6">
        <GuideContentWrapper category={category} slug={slug} />
      </div>

      <script
        type="application/ld+json"
        suppressHydrationWarning
        dangerouslySetInnerHTML={{
          __html: JSON.stringify({
            '@context': 'https://schema.org',
            '@type': 'Article',
            headline: guideTitle,
            description: guideDesc,
            author: { '@type': 'Person', name: guide.author },
            datePublished: guide.last_updated,
            url: pageUrl,
          }),
        }}
      />
    </div>
  )
}

function generateGuideKeywords(guide: Guide, slug: string, lang: TenantKey): string[] {
  // titrage/desc localis√©s (au cas o√π on n‚Äôa pas pass√© des strings d√©j√† r√©solues)
  const titleStr =
    typeof guide.title === 'string' ? guide.title : (guide.title[lang] ?? guide.title.en)
  const descStr =
    typeof guide.description === 'string' ? guide.description : (guide.description[lang] ?? guide.description.en)

  // Bases par langue
  const base_en = [
    'outerplane', 'outerpedia', 'outerplane wiki', 'outerplane guide',
    titleStr, `${titleStr} guide`, slug,
    'turn-based rpg', 'mobile rpg', 'character builds',
  ]
  const base_jp = [
    '„Ç¢„Ç¶„Çø„Éº„Éó„É¨„Éº„É≥', 'Outerpedia', '„Ç¢„Ç¶„Çø„Éº„Éó„É¨„Éº„É≥ ÊîªÁï•', '„Ç¢„Ç¶„Çø„Éº„Éó„É¨„Éº„É≥ „Ç¨„Ç§„Éâ',
    titleStr, `${titleStr} „Ç¨„Ç§„Éâ`,
  ]
  const base_kr = [
    'ÏïÑÏö∞ÌÑ∞ÌîåÎ†àÏù∏', 'Outerpedia', 'ÏïÑÏö∞ÌÑ∞ÌîåÎ†àÏù∏ Í≥µÎûµ', 'ÏïÑÏö∞ÌÑ∞ÌîåÎ†àÏù∏ Í∞ÄÏù¥Îìú',
    titleStr, `${titleStr} Í≥µÎûµ`,
  ]

  // Extras par cat√©gorie (EN/JP/KR)
  const extras: Record<string, { en: string[]; jp: string[]; kr: string[] }> = {
    'adventure': {
      en: ['adventure', 'story mode', 'chapter walkthrough', 'map', 'spoiler-free', 'stage progression', 'pve'],
      jp: ['„Ç¢„Éâ„Éô„É≥„ÉÅ„É£„Éº', '„Çπ„Éà„Éº„É™„Éº„É¢„Éº„Éâ', '„ÉÅ„É£„Éó„Çø„ÉºÊîªÁï•', '„Éû„ÉÉ„Éó', '„Éç„Çø„Éê„É¨ÁÑ°„Åó', '„Çπ„ÉÜ„Éº„Ç∏ÈÄ≤Ë°å', 'PvE'],
      kr: ['Î™®Ìóò', 'Ïä§ÌÜ†Î¶¨ Î™®Îìú', 'Ï±ïÌÑ∞ Í≥µÎûµ', 'Îßµ', 'Ïä§Ìè¨ÏùºÎü¨ ÏóÜÏùå', 'Ïä§ÌÖåÏù¥ÏßÄ ÏßÑÌñâ', 'PVE'],
    },
    'world-boss': {
      en: ['world boss', 'boss strategy', 'team building', 'gear recommendation', 'extreme league', 'pve'],
      jp: ['„ÉØ„Éº„É´„Éâ„Éú„Çπ', '„Éú„ÇπÊîªÁï•', 'Á∑®Êàê', 'Ë£ÖÂÇô„Åä„Åô„Åô„ÇÅ', '„Ç®„ÇØ„Çπ„Éà„É™„Éº„É†„É™„Éº„Ç∞', 'PvE'],
      kr: ['ÏõîÎìú Î≥¥Ïä§', 'Î≥¥Ïä§ Í≥µÎûµ', 'ÌåÄ Íµ¨ÏÑ±', 'Ïû•ÎπÑ Ï∂îÏ≤ú', 'ÏùµÏä§Ìä∏Î¶º Î¶¨Í∑∏', 'PVE'],
    },
    'joint-boss': {
      en: ['joint boss', 'co-op', 'raid score', 'damage optimization', 'team comps', 'pve'],
      jp: ['ÂêàÂêå„Éú„Çπ', 'ÂçîÂäõ', '„Çπ„Ç≥„Ç¢Á®º„Åé', '„ÉÄ„É°„Éº„Ç∏ÊúÄÈÅ©Âåñ', 'Á∑®Êàê', 'PvE'],
      kr: ['Ìï©Îèô Î≥¥Ïä§', 'ÌòëÎèô', 'Î†àÏù¥Îìú Ï†êÏàò', 'Îîú ÏµúÏ†ÅÌôî', 'Ï°∞Ìï©', 'PVE'],
    },
    'adventure-license': {
      en: ['adventure license', 'promotion license', 'license levels', 'license quests', 'pve'],
      jp: ['„Ç¢„Éâ„Éô„É≥„ÉÅ„É£„Éº„É©„Ç§„Çª„É≥„Çπ', 'ÊòáÁ¥ö„É©„Ç§„Çª„É≥„Çπ', '„É©„Ç§„Çª„É≥„Çπ„É¨„Éô„É´', '„É©„Ç§„Çª„É≥„Çπ‰ªªÂãô', 'PvE'],
      kr: ['Î™®Ìóò ÎùºÏù¥ÏÑ†Ïä§', 'ÏäπÍ∏â ÎùºÏù¥ÏÑ†Ïä§', 'ÎùºÏù¥ÏÑ†Ïä§ Î†àÎ≤®', 'ÎùºÏù¥ÏÑ†Ïä§ ÌÄòÏä§Ìä∏', 'PVE'],
    },
    'special-request': { // Gear Boss
      en: ['gear boss', 'special request', 'identification', 'ecology study', 'materials', 'pve'],
      jp: ['Ë£ÖÂÇô„Éú„Çπ', '„Çπ„Éö„Ç∑„É£„É´‰æùÈ†º', 'ÈëëÂÆö', 'ÁîüÊÖãË™øÊüª', 'Á¥†Êùê', 'PvE'],
      kr: ['Ïû•ÎπÑ Î≥¥Ïä§', 'Ïä§ÌéòÏÖú ÏùòÎ¢∞', 'Í∞êÏ†ï', 'ÏÉùÌÉú Ï°∞ÏÇ¨', 'Ïû¨Î£å', 'PVE'],
    },
    'irregular-extermination': {
      en: ['irregular extermination', 'limited-time event', 'event boss', 'rewards', 'pve'],
      jp: ['Áï∞Â∏∏ÂÄã‰ΩìË®é‰ºê', 'ÊúüÈñìÈôêÂÆö„Ç§„Éô„É≥„Éà', '„Ç§„Éô„É≥„Éà„Éú„Çπ', 'Â†±ÈÖ¨', 'PvE'],
      kr: ['Ïù¥Î†àÍ∑§Îü¨ ÌÜ†Î≤å', 'ÌïúÏ†ï Ïù¥Î≤§Ìä∏', 'Ïù¥Î≤§Ìä∏ Î≥¥Ïä§', 'Î≥¥ÏÉÅ', 'PVE'],
    },
    'guild-raid': {
      en: ['guild raid', 'co-op boss', 'weekly ranking', 'guild damage', 'team building', 'pve'],
      jp: ['„ÇÆ„É´„Éâ„É¨„Ç§„Éâ', 'ÂçîÂäõ„Éú„Çπ', 'ÈÄ±Èñì„É©„É≥„Ç≠„É≥„Ç∞', '„ÇÆ„É´„Éâ„ÉÄ„É°„Éº„Ç∏', 'Á∑®Êàê', 'PvE'],
      kr: ['Í∏∏Îìú Î†àÏù¥Îìú', 'ÌòëÎèô Î≥¥Ïä§', 'Ï£ºÍ∞Ñ Îû≠ÌÇπ', 'Í∏∏Îìú Îîú', 'Ï°∞Ìï©', 'PVE'],
    },
    'general-guides': {
      en: ['beginner guide', 'resource management', 'daily routine', 'systems overview', 'tips and tricks', 'pve'],
      jp: ['ÂàùÂøÉËÄÖÂêë„Åë', 'Ë≥áÊ∫êÁÆ°ÁêÜ', 'Êó•Ë™≤', '„Ç∑„Çπ„ÉÜ„É†Ê¶ÇË¶Å', 'Â∞èÊäÄ', 'PvE'],
      kr: ['Ï¥àÎ≥¥Ïûê Í∞ÄÏù¥Îìú', 'ÏûêÏõê Í¥ÄÎ¶¨', 'ÏùºÏùº Î£®Ìã¥', 'ÏãúÏä§ÌÖú Í∞úÏöî', 'ÍøÄÌåÅ', 'PVE'],
    },
    'skyward-tower': {
      en: ['skyward tower', 'floors', 'clear strategy', 'recommended teams', 'pve'],
      jp: ['Â§©Á©∫„ÅÆÂ°î', '„Éï„É≠„Ç¢', 'ÊîªÁï•', '„Åä„Åô„Åô„ÇÅÁ∑®Êàê', 'PvE'],
      kr: ['ÌïòÎäòÌÉë', 'Ï∏µ', 'Í≥µÎûµ', 'Ï∂îÏ≤ú Ï°∞Ìï©', 'PVE'],
    },
    'monad-gate': {
      en: ['monad gate', 'roguelike', 'routes', 'map', 'relics', 'pve'],
      jp: ['„É¢„Éä„Éâ„Ç≤„Éº„Éà', '„É≠„Éº„Ç∞„É©„Ç§„ÇØ', '„É´„Éº„Éà', '„Éû„ÉÉ„Éó', 'ÈÅ∫Áâ©', 'PvE'],
      kr: ['Î™®ÎÇòÎìú Í≤åÏù¥Ìä∏', 'Î°úÍ∑∏ÎùºÏù¥ÌÅ¨', 'Î£®Ìä∏', 'Îßµ', 'Ïú†Î¨º', 'PVE'],
    },
  }

  // Cat√©gorie d√©tect√©e
  const catKey = Object.keys(extras).find(k => guide.category.toLowerCase().includes(k))
  const extra = catKey ? extras[catKey] : null

  // Mots-cl√©s depuis la description (simple heuristique)
  const desc = (descStr ?? '').toLowerCase()
  const descKeywords_en: string[] = []
  if (desc.includes('video')) descKeywords_en.push('video guide')
  if (desc.includes('full run')) descKeywords_en.push('full run')
  if (desc.includes('combat')) descKeywords_en.push('combat footage')
  if (desc.includes('strategy')) descKeywords_en.push('strategy')
  if (desc.includes('boss')) descKeywords_en.push('boss fight')

  // Dates
  const date = new Date(guide.last_updated)
  const year = date.getFullYear()
  const monthName = date.toLocaleString('en-US', { month: 'long' })
  const dateKeywords_en = [`updated ${year}`, `${monthName} ${year}`, `guide ${year}`]

  // Assemblage par langue
  let out: string[]
  if (lang === 'jp') {
    out = [...base_jp, ...(extra ? extra.jp : [])]
  } else if (lang === 'kr') {
    out = [...base_kr, ...(extra ? extra.kr : [])]
  } else {
    out = [...base_en, ...(extra ? extra.en : []), ...descKeywords_en, ...dateKeywords_en]
  }

  return dedupeByLocale(out, lang)
}

